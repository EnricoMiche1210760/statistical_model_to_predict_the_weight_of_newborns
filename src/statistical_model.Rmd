---
title: "Statistical Model To Predict The Weight Of Newborns"
author: "Enrico Michelon"
output:
    pdf_document:
        toc: true
        toc_depth: 3
---

```{r setup, include=FALSE}
library(dplyr)
library(ggplot2)
library(grid)
library(gridExtra)


gini.index <- function(x)
{
  fi2 = (table(x)/length(x))^2
  J = length(table(x))
  gini_index = (1-sum(fi2))/((J-1)/J)
  return(gini_index)
}

ggplot_density.plot <- function(dataset, variable, x_label)
{
  return (ggplot(data = dataset, aes(x = variable)) +
            geom_density(color = "blue") +
            geom_vline(xintercept = quantile(variable, 0.25), color = "red") +
            geom_vline(xintercept = quantile(variable, 0.75), color = "red") +
            labs(x = x_label, y = "Density") +
            theme_minimal()+
            theme(panel.grid.major = element_blank(),
                panel.grid.minor = element_blank(),
                axis.line = element_line(color = "black"))
    )
}


figure.Number = 0

```
## Introduction (Point 2)
This project concerns the creation of a statistical model to predict the weight of newborns. Our objective is to create a
statistical model given the *neonati.csv* dataset that can be extended to the entire population. <br>
In particular we want to find out whether it is possible to predict the infant's weight at birth given all the other variables.
In particular, one wants to study a relationship with the mother's variables, to find out whether or not these have a
not have a significant effect, such as the potentially harmful effect of smoking. The length and diameter of the infant's 
skull are also used because they can be estimated already from ultrasound scans, but in general they could also serve as control 
variables.
```{r dataframe_table, results='asis', echo=FALSE}
newborns_dataset <- read.csv("data/neonati.csv")
knitr::kable(head(newborns_dataset), type = "latex", align='c', booktabs = TRUE,
    caption = "Dataset first rows")
```

## Dataset (Points 1, 2, 3)
The dataset is composed by 2500 samples and, studying its first rows, we can distinguish 10 variables: Anni.madre, N.gravidanze, Fumatrici, Gestazione, 
Peso, Lunghezza, Cranio, Tipo.parto, Ospedale and Sesso. 

### Anni.madre
Anni.madre is a quantitative variable on radio scale. In the dataset we have at least two outlayers, 
which can be found at rows 1152 and 1380, and report an age of 1 and 0, respectively. 
Computing position measures and standard deviation excluding those rows, we obtain:
<div align="center">

```{r anni_madre_summary, results='asis', echo=FALSE}
min_val <- min(newborns_dataset$Anni.madre)
line <- which(newborns_dataset$Anni.madre == min_val)
anni_madre_without_outlayers <- newborns_dataset$Anni.madre[
    -c(line, which(newborns_dataset$Anni.madre == 1))]

sigma.anni_madre <- round(sd(anni_madre_without_outlayers), 2)

df_sigma <- data.frame(std.dev = sigma.anni_madre)

knitr::kable(t(c(round(summary(anni_madre_without_outlayers), 2), df_sigma)),
    type="html", align='c', 
    caption = "Position measures and standard deviation for Anni.madre")
```

</div>

### N.gravidanze
N.gravidanze is a quantitative variable on ratio scale, which represents the number of pregnancy per mother.
In Table 3 position measures and standard deviation for the variable are shown.<br>
We can see that mean and standard deviation and third interquartile are around 1 
(0.98, 1.28 and 1 respectively), while the maximum reaches a value of 12.
<div align="center">

```{r n_gravidanze_summary, results='asis', echo=FALSE}

sigma.n_gravidanze <- round(sd(newborns_dataset$N.gravidanze), 2)

df_sigma <- data.frame(std.dev = sigma.n_gravidanze)

knitr::kable(t(c(round(summary(newborns_dataset$N.gravidanze), 2), df_sigma)),
    type="html", align='c', 
    caption = "Position measures and standard deviation for Anni.madre")

```

</div>

We can look now at the distribution of *N.gravidanze*. From Figure `r figure.Number <- figure.Number + 1; figure.Number` 
we can notice that it is a normal positive skewed distribution, with mean 0.98 and standard deviation of 1.28.
```{r n_gravidanze_density, results='asis', echo=FALSE, fig.align='center', fig.height=3.5, fig.width=6}

density_plot <- ggplot(data = newborns_dataset, 
        aes(x = N.gravidanze)) +
  geom_bar(fill = 'seagreen2') +
  ylab("Mothers") + 
  xlab("Pregnancy number") +
  scale_x_continuous(breaks = seq(0, 12, 1)) +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5),
    panel.grid.major = element_blank())

caption_text <- sprintf("Figure %d: N.gravidanze distribution", figure.Number)
caption_text <- textGrob(caption_text, gp = gpar(fontsize = 9), just = "center")
grid.draw(arrangeGrob(density_plot, bottom = caption_text))
```

### Fumatrici
Fumatrici is a qualitative encoded variable on nominal scale, with values 0 and 1. 
Value 0 means that the mother is not a smoker, while mothers with "Fumatrici" value of
1 means she is a smoker. <br>

```{r fumatrici_summary, echo=FALSE}
fumatrici_gini_coeff <- round(gini.index(newborns_dataset$Fumatrici), 2)
not_smoker_percentage <- table(newborns_dataset$Fumatrici)
```

Computing the Gini coefficient for the variable, we obtain a value of `r fumatrici_gini_coeff`,
which means that the ditribution is not much equally distributed. 
In Figure `r figure.Number <- figure.Number + 1; figure.Number`, the distribution of variable "Fumatrici" is shown.

```{r fumatrici_graphic, results='asis', echo=FALSE, fig.align='center', fig.height=3, fig.width=5}
smoker_plot <- ggplot(data = newborns_dataset) +
  geom_bar(aes(y = Fumatrici, 
               fill = factor(Fumatrici)), width = 0.45,
           position = "identity") +
  xlab("Mothers") +
  ylab("Smoker (yes or no)") + 
  scale_fill_manual("Smoker (0 = No, 1 = Yes):",
                    values = c("0" = 'lightgreen', "1" = 'indianred3')) +
  scale_y_continuous(breaks = seq(0, 1, 1) ) +
  theme_minimal() +
  theme(legend.position = "bottom",
        panel.grid.major = element_blank())

caption_text <- sprintf("Figure %d: Smoker vs Not Smoker", figure.Number)
caption_text <- textGrob(caption_text, gp = gpar(fontsize = 9), just = "center")
grid.draw(arrangeGrob(smoker_plot, bottom = caption_text))
```

### Gestazione
Gestazione is a quantitative variable on ratio scale, measured in weeks, 
with position and standard deviation measures that can be seen in Table 5. <br>
As we expect, the mean value is around 40 weeks (38.98), with a low standard deviation 
of 1.87 weeks.

<div align="center">

```{r gestazione_summary, results='asis', echo=FALSE}

sigma.gestazione <- round(sd(newborns_dataset$Gestazione), 2)

df_sigma <- data.frame(std.dev = sigma.gestazione)   

knitr::kable(t(c(round(summary(newborns_dataset$Gestazione), 2), df_sigma)),
    type="html", align='c', 
    caption = "Position measures and standard deviation for Gestazione")
```
</div>


### Peso
Peso is a quantitative variable on ratio scale, and represents the weight of 
newborns in grams. Position measures and standard deviation are observable in Table 6. 

<div align="center">

```{r peso_summary, results='asis', echo=FALSE}

sigma.Peso <- round(sd(newborns_dataset$Peso), 2)

df_sigma <- data.frame(std.dev = sigma.Peso)   

knitr::kable(t(c(round(summary(newborns_dataset$Peso), 2), df_sigma)),
    type="html", align='c', 
    caption = "Position measures and standard deviation for Peso")
iqr <- IQR(newborns_dataset$Peso)

```
</div>

It is interesting to note that "Peso" has in IQR value of 630 grams, while the range is 
of 4100. This can been explained studying the graphic on Figure `r figure.Number <- figure.Number + 1; figure.Number`.
The distribution is a Normal distribution, negatively skewed, with very long tails,
specially on the left, making a large different between IQR (represented by red line 
on the graphic) and range.

```{r peso_density, results='asis', fig.align='center', echo=FALSE, fig.width=5, fig.height=4}
par(mgp = c(2, 1, 0))
peso_density.plot <- plot(density(newborns_dataset$Peso), 
            col = "blue", main = "", 
            xlab = "Newborns weight")
Q1 <- quantile(newborns_dataset$Peso, .25)
Q3 <- quantile(newborns_dataset$Peso, .75)
abline(v = Q1, col = "red")
abline(v = Q3, col = "red")

caption_text <- sprintf("Figure %d: Peso distribution", figure.Number)
caption_text <- textGrob(caption_text, gp = gpar(fontsize = 9), just = "center")
grid.draw(arrangeGrob(peso_density.plot, bottom = caption_text))

skew <- moments::skewness(newborns_dataset$Peso)

```

### Lunghezza
Lunghezza is a quantitative variable on ratio scale. Represents the length of the newborn in millimeters.
For this variable we expect a behaviour quite similar to variable "Peso". 

<div align="center">

```{r Lunghezza_summary, results='asis', echo=FALSE}

sigma.Lunghezza <- round(sd(newborns_dataset$Lunghezza), 2)

df_sigma <- data.frame(std.dev = sigma.Lunghezza)   

knitr::kable(t(c(round(summary(newborns_dataset$Lunghezza), 2), df_sigma)),
    type="html", align='c', 
    caption = "Position measures and standard deviation for Lunghezza")
```
</div>

```{r Lunghezza_density, results='asis', echo=FALSE, fig.align='center', fig.height=3}

lunghezza_density.plot <- ggplot_density.plot(newborns_dataset, newborns_dataset$Lunghezza, "Lunghezza")

peso_density.plot <- ggplot_density.plot(newborns_dataset, newborns_dataset$Peso, "Peso")
figure.Number <- figure.Number + 1
caption_text <- sprintf("Figure %d: Lunghezza distribution vs. Peso distribution", figure.Number)
caption_text <- textGrob(caption_text, gp = gpar(fontsize = 9), just = "center")
grid.draw(arrangeGrob(lunghezza_density.plot, peso_density.plot, bottom = caption_text, ncol = 2))


skew <- moments::skewness(newborns_dataset$Peso)
skew <- moments::skewness(newborns_dataset$Lunghezza)
```

### Cranio
Cranio is a quantitative variable on ratio scale. Represents the cranium diameter 
of the newborn in millimeters. <br>
In Table 8, we can observe position measures and standard deviation for variable "Cranio". 

<div align="center">

```{r cranio_summary, results='asis', echo=FALSE}

sigma.Cranio <- round(sd(newborns_dataset$Cranio), 2)

df_sigma <- data.frame(std.dev = sigma.Cranio)   

knitr::kable(t(c(round(summary(newborns_dataset$Cranio), 2), df_sigma)),
    type="html", align='c', 
    caption = "Position measures and standard deviation for Cranio")
```

</div>

### Tipo.parto
Tipo.parto is a qualitative variable on nominal scale. Represents the type of childbirth, and is encoded with 
"Nat" (natural) and "Ces" (caesarean). For a qualitative variable we can compute Gini coefficient, which provides
a measure of heterogeneity. Gini coefficient for "Tipo.parto" is 0.83, indicating a very high heterogeneity.

```{r tipo_parto_gini, include=FALSE}
gini_index.Parto <- gini.index(newborns_dataset$Tipo.parto)
```

### Ospedale
Ospedale is a qualitative variable on nominal scale. It represents three different hospitals, and is coded in "osp 1", 
"osp 2" and "osp 3". The Gini coefficient is very close to 1 which means that the variable is almost heterogeneous.

```{r ospedale_gini, include=FALSE}
gini_index.Ospedale <- gini.index(newborns_dataset$Ospedale)
```

### Sesso
Sesso is a qualitative variable on nominal scale. Represents the sex of the newborn, and is coded with "M" for males 
and "F" for females. The Gini coefficient is very close to 1 which means that the variable is almost heterogeneous.
In Figure `r figure.Number <- figure.Number + 1; figure.Number` we can see the distribution of "Sesso".
```{r sesso_gini, include=FALSE}
gini_index.Sesso <- gini.index(newborns_dataset$Sesso)
```

```{r sesso_graphic, results='asis', echo=FALSE, fig.align='center', fig.height=3.5, fig.width=5}
counts <- newborns_dataset %>%
  count(Sesso)

sesso_plot <- ggplot(data = newborns_dataset) + 
  geom_bar(aes(y = Sesso, fill = factor(Sesso)), width = 0.35, position = "identity") +
  geom_text(data = counts, aes(x = n, y = Sesso, label = n, group = Sesso), 
            position = position_dodge(width = 0.35), angle=-90, vjust = -0.5) +
  scale_fill_manual("Sex:", values = c("M" = 'lightblue', "F" = 'lightpink')) +
  theme_minimal() +
  theme(legend.position = "bottom",
        panel.grid.major = element_blank())

caption_text <- sprintf("Figure %d: Sex distribution", figure.Number)
caption_text <- textGrob(caption_text, gp = gpar(fontsize = 9), just = "center")
grid.draw(arrangeGrob(sesso_plot, bottom = caption_text))
```

## Descriptive statistics
In fact in Figure `r figure.Number <- figure.Number + 1; figure.Number` we can see the distribution of "Sesso".

```{r anni_madre_cl_distr, results='asis', fig.align='center', echo=FALSE, fig.height=3.5}
N <- dim(newborns_dataset)[1]
ni <- table(newborns_dataset$Anni.madre)
fi <- ni/N
Ni <- cumsum(ni)
Fi <- Ni/N

freq_distr <- as.data.frame(cbind(ni,fi,Ni,Fi))

anni_madre_cl_distr <- ggplot(freq_distr, aes(x = rownames(freq_distr), y = ni)) +
  geom_bar(stat = "identity", fill = "aquamarine4") +
  ylim(0, 240) +
  labs(x = "Anni.madre", y = "Absolute frequency") +
  theme_minimal()+
  theme(panel.grid.minor = element_blank())

caption_text <- sprintf("Figure %d: Frequency distribution of \"Anni.madre\" class", figure.Number)
caption_text <- textGrob(caption_text, gp = gpar(fontsize = 9), just = "center")
grid.draw(arrangeGrob(anni_madre_cl_distr, bottom = caption_text))

```





